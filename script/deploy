#!/bin/bash

set -eo pipefail

# Validation
echo "ğŸ‘€  Validating..."
[ -z $AWS_PROFILE ] && (echo "Provide an AWS_PROFILE, please!" && exit 1)
git diff-index --quiet HEAD || (echo "Commit your work, please!" && exit 1)
echo "âœ…  Seems legit!"
echo

# Complain about missing variables from now on
set -u

# Run Webpack build
echo "ğŸ”§  Compiling..."
npm run build
cd dist
echo "âœ…  Compiled!"
echo

# Define bucket to upload to
BUCKET="${BUCKET:-"joshmcmillan.com"}"

# Perform upload
echo "â¬†ï¸  Uploading to $BUCKET"
aws s3 sync . s3://$BUCKET --acl public-read
echo "âœ…  Done!"
echo

# Complete
echo "âœ¨  Deployed. We did it!"
